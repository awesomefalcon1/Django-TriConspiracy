{% extends 'blog/base.html' %}

{% block title %}Create New Post{% endblock %}

{% block content %}
  <div class="row">
    <div class="col s12 m8 offset-m2">
      <h4>Create New Post</h4>
      
      
      <form method="post" id="create-post-form">
        {% csrf_token %}
        
        <!-- Hidden author field -->
        <input type="hidden" id="author" name="author" value="{{ user.get_short_fingerprint }}">
        
        <div class="input-field">
          <input id="title" name="title" type="text" required>
          <label for="title">Title *</label>
        </div>
        
        <div class="input-field">
          <textarea id="content" name="content" class="materialize-textarea" required placeholder="You can use Markdown formatting here. Examples: **bold**, *italic*, `code`, # Heading, etc."></textarea>
          <label for="content">Content (Markdown supported) *</label>
          <span class="helper-text">Supports Markdown: **bold**, *italic*, `code`, # headings, lists, links, etc.</span>
        </div>
        
        <div class="input-field">
          <textarea id="excerpt" name="excerpt" class="materialize-textarea"></textarea>
          <label for="excerpt">Excerpt (optional)</label>
        </div>
        
        <div class="input-field">
          <select id="category" name="category">
            <option value="" selected>No Category</option>
            {% for category in categories %}
              <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
          </select>
          <label>Category (select existing or create new below)</label>
        </div>
        
        <div class="input-field">
          <input id="new-category" name="new_category" type="text" placeholder="Enter a new category name to create it">
          <label for="new-category">Create New Category (optional)</label>
          <span class="helper-text">Users can create their own categories for organizing posts</span>
        </div>
        
        <div class="input-field">
          <select id="tags" name="tags" multiple>
            <option value="" disabled>Select Existing Tags</option>
            {% for tag in tags %}
              <option value="{{ tag.id }}">{{ tag.name }}</option>
            {% endfor %}
          </select>
          <label>Tags (select existing or create new below)</label>
        </div>
        
        <div class="input-field">
          <input id="new-tags" name="new_tags" type="text" placeholder="Enter new tags separated by commas (e.g., 'python, django, web')">
          <label for="new-tags">Create New Tags (optional)</label>
          <span class="helper-text">Users can create their own tags for organizing posts. Separate multiple tags with commas.</span>
        </div>
        
        <p>
          <label>
            <input type="checkbox" name="published" id="published" />
            <span>Publish immediately</span>
          </label>
        </p>
        
        <button class="btn waves-effect waves-light purple" type="submit" id="submit-btn">
          <i class="material-icons left">save</i>Create Post
        </button>
        <a href="{% url 'blog:post_list' %}" class="btn-flat">Cancel</a>
      </form>
    </div>
  </div>

  <script>
    $(function(){
      $('select').formSelect();
      
      // Handle category selection - clear new category field when selecting existing
      $('#category').on('change', function() {
        if ($(this).val()) {
          $('#new-category').val('');
        }
      });
      
      // Handle new category input - clear category select when typing
      $('#new-category').on('input', function() {
        if ($(this).val().trim()) {
          $('#category').val('').formSelect();
        }
      });
      
      // Handle tags select - clear new tags input when selecting existing
      $('#tags').on('change', function() {
        if ($(this).val() && $(this).val().length > 0) {
          // Don't clear new tags - allow both existing and new tags
        }
      });
      
      // Handle new tags input - allow both existing and new tags
      $('#new-tags').on('input', function() {
        // Allow both existing tags and new tags to coexist
      });
      
      // Handle form submission
      $('#create-post-form').on('submit', function(e) {
        const title = $('#title').val().trim();
        const content = $('#content').val().trim();
        
        if (!title || !content) {
          e.preventDefault();
          M.toast({html: 'Title and content are required'});
          return false;
        }
        
        // Form will submit normally - no encryption needed
      });
    });
  </script>
{% endblock %}
